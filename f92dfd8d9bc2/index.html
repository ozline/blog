

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://files.ozline.icu/images/site.ico">
  <link rel="icon" href="https://files.ozline.icu/images/site.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="OZLIINEX">
  <meta name="keywords" content="">
  
    <meta name="description" content="Assignment 1 - Performance Analysis on a Quad-Core CPU 我学习的是Spring 2022的版本，作业仓库在这里，下文是我的作业报告。 这个课程的作业感觉都蛮硬核的，然而网上并没有标准答案，我的这份答案也仅供参考 Problem 1 - Parallel Fractal Generation Using Threads   修改mandelbro">
<meta property="og:type" content="article">
<meta property="og:title" content="CMU-15-418 Assignment1 - Performance Analysis on a Quad-Core CPU">
<meta property="og:url" content="https://ozline.icu/f92dfd8d9bc2/index.html">
<meta property="og:site_name" content="OZLIINEX&#39;s Blog">
<meta property="og:description" content="Assignment 1 - Performance Analysis on a Quad-Core CPU 我学习的是Spring 2022的版本，作业仓库在这里，下文是我的作业报告。 这个课程的作业感觉都蛮硬核的，然而网上并没有标准答案，我的这份答案也仅供参考 Problem 1 - Parallel Fractal Generation Using Threads   修改mandelbro">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-04-01T19:11:00.000Z">
<meta property="article:modified_time" content="2023-04-12T11:13:37.559Z">
<meta property="article:author" content="OZLIINEX">
<meta property="article:tag" content="HPC">
<meta property="article:tag" content="cmu15418">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>CMU-15-418 Assignment1 - Performance Analysis on a Quad-Core CPU - OZLIINEX&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/macpanel.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"ozline.icu","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":20,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":202181,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    <!-- 51.la Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('//js.users.51.la/202181.js');
      }
    </script>
  

  

  



  
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="OZLIINEX's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>OZLIINEX&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://files.ozline.icu/images/BannerImg.jpeg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CMU-15-418 Assignment1 - Performance Analysis on a Quad-Core CPU"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-01 19:11" pubdate>
          2023年4月1日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          119 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CMU-15-418 Assignment1 - Performance Analysis on a Quad-Core CPU</h1>
            
            
              <div class="markdown-body">
                
                <h1>Assignment 1 - Performance Analysis on a Quad-Core CPU</h1>
<p>我学习的是<a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/afs/cs/academic/class/15418-s22/www/index.html">Spring 2022</a>的版本，作业仓库<a target="_blank" rel="noopener" href="https://github.com/cmu15418s22/Assignment-1">在这里</a>，下文是我的作业报告。</p>
<p>这个课程的作业感觉都蛮硬核的，然而网上并没有标准答案，我的这份答案也仅供参考</p>
<h2 id="Problem-1-Parallel-Fractal-Generation-Using-Threads">Problem 1 - Parallel Fractal Generation Using Threads</h2>
<ol>
<li class="lvl-3">
<p>修改<code>mandelbrot.cpp</code>中的代码以实现并行计算</p>
</li>
<li class="lvl-3">
<p>修改<code>workerThreadStart</code>的代码以实现</p>
</li>
<li class="lvl-3">
<p>研究针对不同图像的每个线程耗时，并解释原因</p>
</li>
<li class="lvl-3">
<p>实现一个8x的并行程序</p>
</li>
</ol>
<h3 id="Q-A">Q&amp;A</h3>
<blockquote>
<p>Is speedup linear in the number of cores used? In your writeup hypothesize why this is (or is not) the case?</p>
</blockquote>
<p>我们针对<code>view1</code>进行测试</p>
<table>
<thead>
<tr>
<th style="text-align:center">线程</th>
<th style="text-align:center">耗时 /ms</th>
<th style="text-align:center">加速比</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">74.321</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">37.048</td>
<td style="text-align:center">2.01</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">24.824</td>
<td style="text-align:center">2.99</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">18.942</td>
<td style="text-align:center">3.92</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">16.844</td>
<td style="text-align:center">4.41</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">14.119</td>
<td style="text-align:center">5.26</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">12.197</td>
<td style="text-align:center">6.093</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">10.648</td>
<td style="text-align:center">6.979</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">17.736</td>
<td style="text-align:center">4.19</td>
</tr>
</tbody>
</table>
<p>这不是线性的，随着线程数增加，加速比增长速度逐渐下降。一直到9线程（本机CPU是8线程）时加速比降低。</p>
<p>按照理论，如果是线性关系，那么到达8线程的时候应该加速比接近8。考虑到我的本机CPU只有4核心，我不认为在5线程后每个线程性能是一致的。因此我们可以观察4线程时，可以注意到加速比为3.92，是比较接近4x加速的。</p>
<p>我个人认为，在5-8线程中，加速比增速下降的主要原因是cpu调度，cpu任务分配的耗时占了大头。</p>
<p>查阅了一些资料，是因为intel的超线程技术中，单线程性能不及一般线程，这也就解释了为什么5-8线程的时候加速比增速下滑了。</p>
<blockquote>
<p>To confirm (or disprove) your hypothesis, measure the amount of time each thread requires to complete its work by inserting timing code at the beginning and end of workerThreadStart(). How do your measurements explain the speedup graph you previously created?</p>
</blockquote>
<p>在这个问题中，我给每个核心都开了性能模式，因此速度会快一点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ ./mandelbrot --view 1 --threads 4<br>[mandelbrot serial]:            [71.300] ms<br>Wrote image file mandelbrot-v1-serial.ppm<br>[thread 3]: [18.512] ms<br>[thread 2]: [18.527] ms<br>[thread 1]: [18.593] ms<br>[thread 0]: [18.725] ms<br>[thread 2]: [18.523] ms<br>[thread 1]: [18.584] ms<br>[thread 3]: [18.573] ms<br>[thread 0]: [18.591] ms<br>[thread 3]: [18.553] ms<br>[thread 2]: [18.577] ms<br>[thread 1]: [18.655] ms<br>[thread 0]: [18.670] ms<br>[mandelbrot thread]:            [18.669] ms<br>Wrote image file mandelbrot-v1-thread-4.ppm<br>++++                            (3.82x speedup from 4 threads)<br><br>❯ ./mandelbrot --view 2 --threads 4<br>[mandelbrot serial]:            [42.205] ms<br>Wrote image file mandelbrot-v2-serial.ppm<br>[thread 3]: [11.019] ms<br>[thread 2]: [11.066] ms<br>[thread 0]: [11.096] ms<br>[thread 1]: [11.224] ms<br>[thread 2]: [11.047] ms<br>[thread 3]: [11.029] ms<br>[thread 1]: [11.075] ms<br>[thread 0]: [11.124] ms<br>[thread 1]: [11.076] ms<br>[thread 2]: [11.236] ms<br>[thread 3]: [12.659] ms<br>[thread 0]: [12.844] ms<br>[mandelbrot thread]:            [11.173] ms<br>Wrote image file mandelbrot-v2-thread-4.ppm<br>++++                            (3.78x speedup from 4 threads)<br></code></pre></td></tr></table></figure>
<p>其实不明白为何验证非线性结论要求我计算每个线程的耗时</p>
<p>但是我发现了一个新问题：我开了4 threads,但是无论怎么改都有12个输出</p>
<p>后面改了不同的线程，1threads有3个输出，2就有6个，3就有9个，神奇啊（大雾）</p>
<blockquote>
<p>Modify the mapping of work to threads to improve speedup to 8× on view 0 and almost 8× on views 1 and 2. In your writeup, describe your approach and report the final 16-thread 3 speedup obtained. Also comment on the difference in scaling behavior from 4 to 8 threads versus 8 to 16 threads.</p>
</blockquote>
<p>就是让我们改程序，以让它可以实现8x速度，但是cmu的高端电脑似乎是8核心16线程的，我的老破小是4核心8线程的，应该只要实现4x速度吧（大雾）</p>
<p>但是似乎已经改不到更快了，3.92x已经是极限了（悲）</p>
<h3 id="Code">Code</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Line 109-128</span><br><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">workerThreadStart</span><span class="hljs-params">(<span class="hljs-type">void</span> *threadArgs)</span> </span>&#123;<br>    WorkerArgs *args = <span class="hljs-built_in">static_cast</span>&lt;WorkerArgs *&gt;(threadArgs);<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement worker thread here.</span><br>    <span class="hljs-type">int</span> threadNumRows = args-&gt;height / args-&gt;numThreads;<br>    <span class="hljs-keyword">if</span>(args-&gt;height % args-&gt;numThreads != <span class="hljs-number">0</span>) &#123;<br>        threadNumRows++;<br>    &#125;<br>    <span class="hljs-comment">// int threadStartRow = args-&gt;threadId * threadNumRows;</span><br>    <span class="hljs-comment">// int threadTotalRows = threadNumRows;</span><br><br>    <span class="hljs-comment">// mandelbrotSerial(args-&gt;x0, args-&gt;y0, args-&gt;x1, args-&gt;y1, args-&gt;width, args-&gt;height, threadStartRow, threadTotalRows, args-&gt;maxIterations, args-&gt;output);</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; threadNumRows; i++) &#123;<br>        <span class="hljs-type">int</span> threadStartRow = i * args-&gt;numThreads + args-&gt;threadId;<br>        <span class="hljs-keyword">if</span>(threadStartRow &lt; args-&gt;height) &#123;<br>            <span class="hljs-built_in">mandelbrotSerial</span> (args-&gt;x0, args-&gt;y0, args-&gt;x1, args-&gt;y1, args-&gt;width, args-&gt;height, threadStartRow, <span class="hljs-number">1</span>, args-&gt;maxIterations, args-&gt;output);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// Line 147 - 159</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numThreads; i++) &#123;<br>    args[i].threadId = i;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Set thread arguments here</span><br>    args[i].x0 = x0, args[i].y0 = y0;<br>    args[i].x1 = x1, args[i].y1 = y1;<br>    args[i].width = width;<br>    args[i].height = height;<br>    args[i].maxIterations = maxIterations;<br>    args[i].output = output;<br>    args[i].numThreads = numThreads;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="Problem-2-Vectorizing-Code-Using-SIMD-Intrinsics">Problem 2 - Vectorizing Code Using SIMD Intrinsics</h2>
<ol>
<li class="lvl-3">
<p>修改<code>functions.cpp</code>中的<code>clampedExpVector()</code>以实现并行快速幂</p>
</li>
<li class="lvl-3">
<p>修改<code>functions.cpp</code>中的<code>arraySumVector()</code>以实现并行数组求和</p>
</li>
</ol>
<h3 id="Q-A-2">Q&amp;A</h3>
<blockquote>
<p>How much does the vector utilization change as W changes? Explain the reason for these changes and the degree of sensitivity the uti-lization has on the vector width. Explain how the total number of vector instructions varies with W .</p>
</blockquote>
<p>我们运行参数为<code>./vrun -s 10000</code></p>
<table>
<thead>
<tr>
<th>Vector Width</th>
<th>Vector Utilization</th>
<th>Total Vector Instructions</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>92.980082%</td>
<td>383929</td>
</tr>
<tr>
<td>4</td>
<td>92.812667%</td>
<td>196495</td>
</tr>
<tr>
<td>8</td>
<td>92.777550%</td>
<td>98739</td>
</tr>
<tr>
<td>16</td>
<td>92.776768%</td>
<td>49378</td>
</tr>
<tr>
<td>32</td>
<td>92.778057%</td>
<td>24651</td>
</tr>
</tbody>
</table>
<p>我们可以发现的，在误差范围内，当向量宽度逐渐变大时，我们向量利用率是逐步下降的，但是下降速率逐渐降低</p>
<p>利用率下降的主要原因应该是，代码中我对余数部分的数组线性处理，而当宽度变大时，线性处理的部分也会增加</p>
<h3 id="Code-2">Code</h3>
<p>我一开始是直接把上面的快速幂改成向量的，只处理了除不尽的情况，然后当s 为奇数的时候会Fail</p>
<p>后面忘记看了什么资料发现别人的代码中是移走if(result &gt; 4.18f)的代码到while结束，手动改了一下就过了</p>
<p>2023-03-31：重新回顾了一下这个代码，发现我们不需要线性处理，我们只需要设置一下掩码即可，修改后效率可以达到<code>94.207317%</code>，提升2%</p>
<p>下面这份是修改后的代码，修改前的话则是对余数部分线性处理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clampedExpVector</span><span class="hljs-params">(<span class="hljs-type">float</span> *values, <span class="hljs-type">int</span> *exponents, <span class="hljs-type">float</span> *output, <span class="hljs-type">int</span> N)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement your vectorized version of clampedExpSerial here</span><br>    __cmu418_vec_float x, result, xpower;<br>    __cmu418_vec_int y, tmp_y; <span class="hljs-comment">// tmp_y stores y &amp; 0x1</span><br><br>    __cmu418_vec_float exp = _cmu418_vset_float(<span class="hljs-number">4.18f</span>);<br>    __cmu418_vec_int zero = _cmu418_vset_int(<span class="hljs-number">0</span>);<br>    __cmu418_vec_int one = _cmu418_vset_int(<span class="hljs-number">1</span>);<br><br>    __cmu418_mask maskAll, maskIsNegative, maskIsNotNegative, maskResultIsClamped;<br><br>    <span class="hljs-type">int</span> cnt = N % VECTOR_WIDTH;<br>    <span class="hljs-comment">// if(cnt) clampedExpSerial(values, exponents, output, cnt); // Serial Solve</span><br><br>    <span class="hljs-comment">// Vector Solve</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += VECTOR_WIDTH) &#123;<br>        maskAll = (i == <span class="hljs-number">0</span> &amp;&amp; cnt) ? _cmu418_init_ones(cnt) : _cmu418_init_ones();<br>        maskIsNegative = _cmu418_init_ones(<span class="hljs-number">0</span>);<br><br>        _cmu418_vload_float(x, values + i, maskAll);                    <span class="hljs-comment">// x = values[i];</span><br>        _cmu418_vset_float(result, <span class="hljs-number">1.f</span>, maskAll);                       <span class="hljs-comment">// result = 1.f;</span><br>        _cmu418_vload_int(y, exponents + i, maskAll);                   <span class="hljs-comment">// y = exponents[i];</span><br>        _cmu418_vmove_float(xpower, x, maskAll);                        <span class="hljs-comment">// xpower = x;</span><br><br>        <span class="hljs-keyword">while</span>(_cmu418_vgt_int(maskIsNegative, y, zero, maskAll), _cmu418_cntbits(maskIsNegative)) <span class="hljs-comment">// while(y &gt; 0)</span><br>        &#123;<br>            _cmu418_vbitand_int(tmp_y, y, one, maskAll);                        <span class="hljs-comment">// tmp_y = y &amp; 0x1</span><br>            _cmu418_vgt_int(maskIsNegative, tmp_y, zero, maskAll);              <span class="hljs-comment">// if(tmp_y) &#123;</span><br>            _cmu418_vmult_float(result, result, xpower, maskIsNegative);        <span class="hljs-comment">//  result *= xpower</span><br>                                                                                <span class="hljs-comment">// &#125;</span><br>            _cmu418_vmult_float(xpower, xpower, xpower, maskAll);               <span class="hljs-comment">// xpower *= xpower</span><br>            _cmu418_vshiftright_int(y, y, one, maskAll);                        <span class="hljs-comment">// y &gt;&gt;= 1</span><br>        &#125;<br><br>        _cmu418_vgt_float(maskResultIsClamped, result, exp, maskAll);   <span class="hljs-comment">//  if(result &gt; 4.18f) &#123;</span><br>        _cmu418_vmove_float(result, exp, maskResultIsClamped);          <span class="hljs-comment">//      result = 4.18f</span><br>                                                                        <span class="hljs-comment">//  &#125;</span><br>        _cmu418_vstore_float(output + i, result, maskAll);              <span class="hljs-comment">// output[i] = result</span><br><br>        <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span> &amp;&amp; cnt) i -= VECTOR_WIDTH;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里有个未解之谜，关于Bonus的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">arraySumVector</span><span class="hljs-params">(<span class="hljs-type">float</span> *values, <span class="hljs-type">int</span> N)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement your vectorized version here</span><br><br>    __cmu418_vec_float x, result;<br>    __cmu418_vec_float zero = _cmu418_vset_float(<span class="hljs-number">0.f</span>);<br>    __cmu418_mask maskAll, maskIsNegative, maskIsNotNegative;<br><br>    <span class="hljs-type">float</span> sum[VECTOR_WIDTH];<br>    <span class="hljs-type">float</span> ans = <span class="hljs-number">0.f</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; VECTOR_WIDTH; i++)<br>    &#123;<br>        sum[i] = <span class="hljs-number">0.f</span>;<br>        <span class="hljs-comment">// printf(&quot;sum[%d] = %f\n&quot;, i, sum[i]);</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += VECTOR_WIDTH)<br>    &#123;<br>        maskAll = _cmu418_init_ones();<br>        maskIsNegative = _cmu418_init_ones(<span class="hljs-number">0</span>);<br><br>        _cmu418_vload_float(x, values + i, maskAll);                        <span class="hljs-comment">// x = values[i];</span><br>        _cmu418_vadd_float(result, result, x, maskAll);                     <span class="hljs-comment">// result += x;</span><br>        _cmu418_vstore_float(sum + (i % VECTOR_WIDTH), result, maskAll);    <span class="hljs-comment">// sum[i] = result;</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; VECTOR_WIDTH; i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sum[%d] = %f\n&quot;</span>, i, sum[i]), ans += sum[i];<br><br>    <span class="hljs-keyword">return</span> ans;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这是我的这份代码，可以注意到我有一个printf的输出，当我注释掉输出时，会输出如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">ARRAY <span class="hljs-title">SUM</span> <span class="hljs-params">(bonus)</span></span><br><span class="hljs-function">sum[0] </span>= <span class="hljs-number">-1.010000</span><br>sum[<span class="hljs-number">1</span>] = <span class="hljs-number">-1.007556</span><br>sum[<span class="hljs-number">2</span>] = <span class="hljs-number">-1.005328</span><br>sum[<span class="hljs-number">3</span>] = <span class="hljs-number">-1.000470</span><br>sum[<span class="hljs-number">4</span>] = <span class="hljs-number">-1.006793</span><br>sum[<span class="hljs-number">5</span>] = <span class="hljs-number">-1.003835</span><br>sum[<span class="hljs-number">6</span>] = <span class="hljs-number">-256138150223410355193484371034112.000000</span><br>sum[<span class="hljs-number">7</span>] = <span class="hljs-number">-1.000535</span><br>Expected <span class="hljs-number">-8.032826</span>, got <span class="hljs-number">-256138150223410355193484371034112.000000</span><br>.@@@ Failed!!!<br></code></pre></td></tr></table></figure>
<p>当我没有注释输出时，会输出如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">ARRAY <span class="hljs-title">SUM</span> <span class="hljs-params">(bonus)</span></span><br><span class="hljs-function">sum[0] </span>= <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">1</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">2</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">3</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">4</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">5</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">6</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">7</span>] = <span class="hljs-number">0.000000</span><br>sum[<span class="hljs-number">0</span>] = <span class="hljs-number">-1.000000</span><br>sum[<span class="hljs-number">1</span>] = <span class="hljs-number">-1.007556</span><br>sum[<span class="hljs-number">2</span>] = <span class="hljs-number">-1.015328</span><br>sum[<span class="hljs-number">3</span>] = <span class="hljs-number">-1.000470</span><br>sum[<span class="hljs-number">4</span>] = <span class="hljs-number">-1.006793</span><br>sum[<span class="hljs-number">5</span>] = <span class="hljs-number">-1.003835</span><br>sum[<span class="hljs-number">6</span>] = <span class="hljs-number">-1.008310</span><br>sum[<span class="hljs-number">7</span>] = <span class="hljs-number">-1.000535</span><br>Expected <span class="hljs-number">-8.032826</span>, got <span class="hljs-number">-8.042827</span><br>.@@@ Failed!!!<br></code></pre></td></tr></table></figure>
<p>？？？多一个printf会有这么大的影响嘛，不过最终答案的确也是错的，不知道发生了什么。太玄学了！</p>
<p>看了一下<code>CMU418intrin.h</code>，我们肯定是要用上<code>_cmu418_hadd_float()</code>和<code>_cmu418_interleave_float()</code>的，因为这两个很突兀。第一个是实现[0 1 2 3] -&gt; [0+1 0+1 2+3 2+3]，不好描述，就是按pair相加，第二个是实现把一个数组的奇数下标移到前半部分，偶数下标移动到后半部分</p>
<p>很明显嘛，就是循环使用这两个函数，类似二分，每次都会折半，题目中说了VECTOR_WIDTH是2的倍数，那么我们可以按位处理。</p>
<p>然后同时还发现了这行代码<code>template &lt;typename T&gt; struct __cmu418_vec &#123; T value[VECTOR_WIDTH]; &#125;;</code>，原来可以直接输出向量的某一个下标</p>
<p>那就好办了，不需要sum了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">arraySumVector</span><span class="hljs-params">(<span class="hljs-type">float</span> *values, <span class="hljs-type">int</span> N)</span> </span>&#123;<br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement your vectorized version here</span><br><br>    __cmu418_vec_float x, result = _cmu418_vset_float(<span class="hljs-number">0.f</span>);<br>    __cmu418_mask maskAll = _cmu418_init_ones();<br>    <span class="hljs-type">int</span> cnt = VECTOR_WIDTH;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += VECTOR_WIDTH)<br>    &#123;<br>        _cmu418_vload_float(x, values + i, maskAll);                        <span class="hljs-comment">// x = values[i];</span><br>        _cmu418_vadd_float(result, result, x, maskAll);                     <span class="hljs-comment">// result += x;</span><br>    &#125;<br><br>    <span class="hljs-keyword">while</span>(cnt &gt;&gt;= <span class="hljs-number">1</span>)<br>    &#123;<br>        _cmu418_hadd_float(result, result);<br>        _cmu418_interleave_float(result, result);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> result.value[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ ./vrun -s 8<br>CLAMPED EXPONENT (required)<br>Results matched with answer!<br>****************** Printing Vector Unit Statistics *******************<br>Vector Width:              8<br>Total Vector Instructions: 82<br>Vector Utilization:        93.140244%<br>Utilized Vector Lanes:     611<br>Total Vector Lanes:        656<br>************************ Result Verification *************************<br>Passed!!!<br><br>ARRAY SUM (bonus)<br>Passed!!!<br></code></pre></td></tr></table></figure>
<h2 id="Problem-3-Using-Instruction-level-Parallelism-in-Fractal-Generation">Problem 3 - Using Instruction-level Parallelism in Fractal Generation</h2>
<ol>
<li class="lvl-3">
<p>理解并注释<code>mandelbrot_ref_loop.s</code>中的代码</p>
</li>
</ol>
<h3 id="Q-A-3">Q&amp;A</h3>
<blockquote>
<p>An annotated  version of the assembly code for the main loop of mandel ref</p>
</blockquote>
<p>我们可以在这里查询汇编指令：<a target="_blank" rel="noopener" href="https://www.felixcloutier.com/x86/index.html">x86 and amd64 instruction reference</a></p>
<p>我们可以在这里查询一些其他资料：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/566499032">并发原理 — CPU原子性指令（一）</a></p>
<p>那么其实就是查询汇编的答案了，但是还是有点不会。</p>
<p>要知道一些基本信息，例如x86-64的16个64位寄存器</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%xmmi</td>
<td>128位寄存器，i为编号</td>
</tr>
<tr>
<td>%rip</td>
<td>指向下一条要执行的指令</td>
</tr>
<tr>
<td>%eax</td>
<td>accumulator, 加乘法指令缺省寄存器</td>
</tr>
<tr>
<td>%edi</td>
<td>destination indexm, 目标索引寄存器</td>
</tr>
</tbody>
</table>
<blockquote>
<p>An analysis of the latency bound of mandel ref and how the measured performance compares.</p>
</blockquote>
<p>主要是提交一份Mandel Ref的延迟分析</p>
<p>这份代码中我觉得比较多的是xmm寄存器的操作，查看Assignments的介绍中有提及：U0可以执行加乘除、U1可以执行加乘、U5可以做浮点加法，但是只能使用x87浮点指令。U0/U1有4个时钟周期，U5有3个时钟周期。</p>
<p>但是我没有在<a target="_blank" rel="noopener" href="https://agner.org/optimize/microarchitecture.pdf">The microarchitecture of Intel and AMD CPUs</a>中对应页面找到解释（？）难道是更新了，似乎是在P155</p>
<p>这部分很薄弱，我的分析可能存在问题：</p>
<p>整个loop中涉及到了4次寄存器乘法，5次寄存器加法，还有2次jmp，latency至少是4 * 4 + 5 * 3 + 1 * 2 = 26时钟周期</p>
<blockquote>
<p>Considering the floating-point operations, what is the highest throughput bound imposed by the functional units?</p>
</blockquote>
<p>考虑浮点运算，功能单元所施加的最高吞吐量是多少</p>
<p>这个超纲了啊！！！</p>
<h3 id="Code-3">Code</h3>
<p>以下给出这份代码的注释版本，但是我感觉没有写好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs assembly">        # This is the inner loop of mandel_ref<br>        # Parameters are passed to the function as follows:<br>        #   %xmm0: c_re<br>        #   %xmm1: c_im<br>        #   %edi:  count<br>        # Before entering the loop, the function sets registers<br>		# to initialize local variables:<br>        #   %xmm2: z_re = c_re<br>        #   %xmm3: z_im = c_im<br>        #   %eax:  i = 0<br>.L123:<br>        vmulss  %xmm2, %xmm2, %xmm4					# xmm2 *= xmm4<br>        vmulss  %xmm3, %xmm3, %xmm5					# xmm3 *= xmm5<br>        vaddss  %xmm5, %xmm4, %xmm6					# xmm5 = xmm4 * xmm6<br>        vucomiss        .LC0(%rip), %xmm6			# Compare xmm1 and xmm6 and set the EFLAGS flags accordingly.<br>        ja      .L126								# if larger, jump to .L126<br>        vaddss  %xmm2, %xmm2, %xmm2					# xmm2 += xmm2<br>        addl    $1, %eax							# count++<br>        cmpl    %edi, %eax   						# Set condition codes for jne below<br>        vmulss  %xmm3, %xmm2, %xmm3					# xmm3 *= xmm2<br>        vsubss  %xmm5, %xmm4, %xmm2					# xmm5 = xmm4 - xmm2<br>        vaddss  %xmm3, %xmm1, %xmm3					# xmm3 += xmm1<br>        vaddss  %xmm2, %xmm0, %xmm2					# xmm2 += xmm0<br>        jne     .L123<br></code></pre></td></tr></table></figure>
<h2 id="Problem-4-Parallel-Fractal-Generation-Using-ISPC">Problem 4 - Parallel Fractal Generation Using ISPC</h2>
<p>出了点小插曲，我的电脑中因为更新已经删除了<code>sys/sysctl.h</code>，不过似乎注释掉<code>common/tasksys.h</code>中的include就可以编译了，那导入这个库干嘛…</p>
<h3 id="Problem-4-Part-1-A-Few-ISPC-Basics">Problem 4, Part 1. A Few ISPC Basics</h3>
<ol>
<li class="lvl-3">
<p>编译程序，并提出自己认为的理论值</p>
</li>
</ol>
<h4 id="Q-A-4">Q&amp;A</h4>
<blockquote>
<p>What is the maximum speedup you expect given what you know about these CPUs? Why might the number you observe be less than this ideal?</p>
</blockquote>
<p>首先，既然是 8-wide AVX vector instructions，那理论加速比应当为8x，但是实际上我跑的理论加速比只有4.48x</p>
<p>我认为没有达到实际加速比是因为调度问题，毕竟不可能直接到8x，但是4.48x的差距还是太大了，说明不止是调度问题</p>
<p>查阅了网上<s>的标准答案</s>他人的想法， 负载不均衡的问题可能是比较正确的，我们实际上跑的这个图不是均匀的，那么就会造成有的快有的慢。</p>
<h3 id="Problem-4-Part-2-Combining-instruction-level-and-SIMD-parallelism">Problem 4, Part 2. Combining instruction-level and SIMD parallelism</h3>
<h4 id="Q-A-5">Q&amp;A</h4>
<blockquote>
<p>How much speedup does this two-way parallelism give over the regular ISPC version? Does it vary across different inputs (i.e., different --views)? When is it worth the effort?</p>
</blockquote>
<p>这道题做崩了，反向加速了，但是可以注意到在视图不同的时候，反向加速效果也是不一样的，但是我感觉我的代码没有很大的问题，实在是不知道为啥反向加速了，难道是自己电脑CPU太古早了？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ ./mandelbrot_ispc -v 1<br>[mandelbrot serial]:            [183.684] ms<br>Wrote image file mandelbrot-1-serial.ppm<br>[mandelbrot ispc]:              [44.045] ms<br>Wrote image file mandelbrot-1-ispc.ppm<br>[mandelbrot ispc parallel]:             [66.698] ms<br>Wrote image file mandelbrot-1-ispc-par.ppm<br>                                (4.17x speedup from ISPC)<br>                                (2.75x speedup from ISPC+parallelism)<br>❯ ./mandelbrot_ispc -v 2<br>[mandelbrot serial]:            [107.956] ms<br>Wrote image file mandelbrot-2-serial.ppm<br>[mandelbrot ispc]:              [30.914] ms<br>Wrote image file mandelbrot-2-ispc.ppm<br>[mandelbrot ispc parallel]:             [43.129] ms<br>Wrote image file mandelbrot-2-ispc-par.ppm<br>                                (3.49x speedup from ISPC)<br>                                (2.50x speedup from ISPC+parallelism)<br>❯ ./mandelbrot_ispc -v 3<br>[mandelbrot serial]:            [260.036] ms<br>Wrote image file mandelbrot-3-serial.ppm<br>[mandelbrot ispc]:              [65.158] ms<br>Wrote image file mandelbrot-3-ispc.ppm<br>[mandelbrot ispc parallel]:             [89.083] ms<br>Wrote image file mandelbrot-3-ispc-par.ppm<br>                                (3.99x speedup from ISPC)<br>                                (2.92x speedup from ISPC+parallelism)<br>❯ ./mandelbrot_ispc -v 4<br>[mandelbrot serial]:            [257.352] ms<br>Wrote image file mandelbrot-4-serial.ppm<br>[mandelbrot ispc]:              [64.656] ms<br>Wrote image file mandelbrot-4-ispc.ppm<br>[mandelbrot ispc parallel]:             [88.640] ms<br>Wrote image file mandelbrot-4-ispc-par.ppm<br>                                (3.98x speedup from ISPC)<br>                                (2.90x speedup from ISPC+parallelism)<br></code></pre></td></tr></table></figure>
<h4 id="Code-4">Code</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">export</span> <span class="hljs-type">void</span> <span class="hljs-title">mandelbrot_ispc_par2</span><span class="hljs-params">(uniform <span class="hljs-type">float</span> x0, uniform <span class="hljs-type">float</span> y0,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 uniform <span class="hljs-type">float</span> x1, uniform <span class="hljs-type">float</span> y1,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 uniform <span class="hljs-type">int</span> width, uniform <span class="hljs-type">int</span> height,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 uniform <span class="hljs-type">int</span> maxIterations,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 uniform <span class="hljs-type">int</span> output[])</span> </span>&#123;<br>    uniform <span class="hljs-type">float</span> dx = (x1 - x0) / width;<br>    uniform <span class="hljs-type">float</span> dy = (y1 - y0) / height;<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Write ISPC code that will use function mandel_par2 to process</span><br>    <span class="hljs-comment">// two rows on each pass.</span><br>    <span class="hljs-comment">// You should use the foreach construct.</span><br>    <span class="hljs-comment">// You should handle the case where the height is not a multiple</span><br>    <span class="hljs-comment">// of 2.</span><br><br>    uniform <span class="hljs-type">int</span> numRowsPerPass = (height + <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>;<br><br>    foreach (i = <span class="hljs-number">0</span> ... numRowsPerPass, j = <span class="hljs-number">0</span> ... width) &#123;<br>        <span class="hljs-type">int</span> row0 = i * <span class="hljs-number">2</span>;<br>        <span class="hljs-type">int</span> row1 = <span class="hljs-built_in">min</span>(row0 + <span class="hljs-number">1</span>, height - <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">float</span> c_re0 = x0 + j * dx;<br>        <span class="hljs-type">float</span> c_im0 = y0 + row0 * dy;<br>        <span class="hljs-type">float</span> c_re1 = x0 + j * dx;<br>        <span class="hljs-type">float</span> c_im1 = y0 + row1 * dy;<br><br>        <span class="hljs-built_in">mandel_par2</span>(c_re0, c_im0, c_re1, c_im1, maxIterations, output + row0 * width + j, output + row1 * width + j);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Problem-4-Part-3-ISPC-Tasks">Problem 4, Part 3: ISPC Tasks</h3>
<ol>
<li class="lvl-3">
<p>尝试不同的BLOCK大小与TASK数量，以超过20x加速</p>
</li>
</ol>
<p>最终是<code>20.99x</code>加速，参数是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_WIDTH 400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_HEIGHT 200</span><br>uniform <span class="hljs-type">int</span> taskCount = <span class="hljs-number">16</span>;<br></code></pre></td></tr></table></figure>
<p>不过这个20.99x也蛮极限的，可能原因是CPU是4核心8线程的，16task其实是有点高了</p>
<p>有一个问题是说</p>
<h2 id="Problem-5-Iterative-Cubic-Root">Problem 5 - Iterative Cubic Root</h2>
<ol>
<li class="lvl-3">
<p>运行迭代立方根程序，看结果</p>
</li>
<li class="lvl-3">
<p>修改<code>data.cpp</code>中的内容，调优</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ ./cuberoot<br>[cuberoot serial]:              [3658.882] ms<br>[cuberoot ispc]:                [884.804] ms<br>[cuberoot task ispc]:   [134.455] ms<br>                                (4.14x speedup from ISPC)<br>                                (27.21x speedup from task ISPC)<br></code></pre></td></tr></table></figure>
<h3 id="Q-A-6">Q&amp;A</h3>
<blockquote>
<p>Modify the function initGood/initBad() in the file data.cpp to generate data that will yield a very high relative speedup of the ISPC implementations.</p>
<p>Does your modification improve SIMD speedup? Does it improve multi-core speedup? Please explain why.</p>
</blockquote>
<p>我最多可以跑到40x左右的加速，这时候<code>value[i] = 1.9999999</code>，似乎可以无限逼近2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ ./cuberoot -d g<br>[cuberoot serial]:              [7345.921] ms<br>[cuberoot ispc]:                [1190.029] ms<br>[cuberoot task ispc]:   [178.646] ms<br>                                (6.17x speedup from ISPC)<br>                                (41.12x speedup from task ISPC)<br></code></pre></td></tr></table></figure>
<p>最慢可以达到2.3x的加速，这时候<code>value[i] = 1.0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[cuberoot serial]:              [80.059] ms<br>[cuberoot ispc]:                [43.914] ms<br>[cuberoot task ispc]:   [34.633] ms<br>                                (1.82x speedup from ISPC)<br>                                (2.31x speedup from task ISPC)<br></code></pre></td></tr></table></figure>
<p>实际上修改为1就可以实现最慢了，-1应该也可以，可以观察给的图形，在正负1.0处迭代最少，在无限逼近2的时候迭代次数徒增</p>
<p>要解释的话，我们可以说明ispc可以更好的处理数学计算？加速数学计算的过程吧。</p>
<p>这个问题5似乎比前面几个来的简单多啊。。这个看起来得放在第一问（）</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%B6%85%E7%AE%97/" class="category-chain-item">超算</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/HPC/">#HPC</a>
      
        <a href="/tags/cmu15418/">#cmu15418</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/e4edabdd2525/" title="HPL本机性能调优分析">
                        <span class="hidden-mobile">HPL本机性能调优分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       © OZLIINEX Proudly published with <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> Theme <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      闽ICP备2021014966号
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35010202001466"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="https://files.ozline.icu/images/ghs.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>闽公网安备35010202001466号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
